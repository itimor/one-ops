(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-4ac48080"],{"2a87":function(t,s,e){},8418:function(t,s,e){"use strict";e.r(s);var i=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"chat-app"},[e("div",{staticClass:"chat-container"},[e("div",{staticClass:"chat-sider"},[e("mycard")],1),t._v(" "),e("div",{staticClass:"chat-main"},[e("div",{staticClass:"chat-group"},[e("div",{staticClass:"chat-search"},[e("el-input",{staticClass:"searchInput",attrs:{type:"text","suffix-icon":"el-icon-search",placeholder:"搜索"},model:{value:t.listQuery.search,callback:function(s){t.$set(t.listQuery,"search",s)},expression:"listQuery.search"}})],1),t._v(" "),e("div",{staticClass:"chat-group-list"},[e("ul",t._l(t.group_list,(function(s){return e("li",{key:s.id,staticClass:"group-list",class:{active:s.id===t.selectId},on:{click:function(e){return t.selectGroup(s)}}},[e("div",{staticClass:"list-left"},[e("img",{staticClass:"avatar",attrs:{width:"42",height:"42",alt:s.name,src:s.create_user.avatar}})]),t._v(" "),e("div",{staticClass:"list-right"},[e("span",{staticClass:"time"},[t._v(t._s(t._f("chatTime")(s.messages[s.messages.length-1].create_time)))]),t._v(" "),e("p",{staticClass:"name"},[t._v(t._s(s.name))]),t._v(" "),e("p",{staticClass:"lastmsg"},[t._v(t._s(s.messages[s.messages.length-1].message))])])])})),0)])]),t._v(" "),t.selectId<1?e("div",{staticClass:"chat-message"},[e("p",{staticClass:"empty_tip"},[t._v("点击左侧群组，开启奇妙对话")])]):e("div",{staticClass:"chat-message"},[e("div",{staticClass:"message"},[e("header",{staticClass:"header"},[e("div",{staticClass:"friendname"},[t._v("\n              "+t._s(t.selectName)+"\n              "),t._m(0)])]),t._v(" "),e("div",{ref:"list_message",staticClass:"message-wrapper"},[e("ul",t._l(t.message_list,(function(s){return e("li",{key:s.id,staticClass:"message-item"},[e("div",{staticClass:"time"},[e("span",[t._v(t._s(t._f("chatTime")(s.create_time)))])]),t._v(" "),e("div",{staticClass:"main",class:s.create_user.id===t.user_id?"self":"other"},[e("img",{staticClass:"avatar",attrs:{width:"36",height:"36",src:s.create_user.avatar}}),t._v(" "),e("div",{staticClass:"content"},[e("div",{staticClass:"message-text",domProps:{innerHTML:t._s(s.message)}})])])])})),0)])]),t._v(" "),e("div",{staticClass:"text"},[t._m(1),t._v(" "),e("textarea",{directives:[{name:"model",rawName:"v-model",value:t.temp.message,expression:"temp.message"}],ref:"text",domProps:{value:t.temp.message},on:{keyup:t.onKeyup,input:function(s){s.target.composing||t.$set(t.temp,"message",s.target.value)}}}),t._v(" "),e("div",{staticClass:"send",on:{click:t.sendMessage}},[e("span",[t._v("发送(S)")])]),t._v(" "),e("transition",{attrs:{name:"appear"}},[e("div",{directives:[{name:"show",rawName:"v-show",value:t.empty_warn,expression:"empty_warn"}],staticClass:"warn"},[e("div",{staticClass:"description"},[t._v("不能发送空白信息")])])])],1)])])])])},a=[function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("span",[e("i",{staticClass:"el-icon-more"})])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"emoji"},[e("i",{staticClass:"icon icon-lock el-icon-picture-outline-round"}),t._v(" "),e("i",{staticClass:"icon icon-look el-icon-folder"}),t._v(" "),e("i",{staticClass:"icon icon-look el-icon-scissors"}),t._v(" "),e("i",{staticClass:"icon icon-look el-icon-chat-dot-round"})])}],c=(e("a481"),e("7f7f"),e("2d63")),o=e("db72"),n=e("8c63"),r=e("2f62"),l=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"mycard"},[e("header",[e("el-avatar",{staticClass:"avatar",attrs:{shape:"square",src:t.avatar}})],1),t._v(" "),t._m(0),t._v(" "),t._m(1)])},u=[function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"navbar"},[e("i",{staticClass:"icon el-icon-chat-round",staticStyle:{color:"green"}}),t._v(" "),e("i",{staticClass:"icon el-icon-connection"}),t._v(" "),e("i",{staticClass:"icon el-icon-picture-outline"})])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("footer",[e("i",{staticClass:"icon el-icon-mobile-phone"}),t._v(" "),e("i",{staticClass:"icon el-icon-place"}),t._v(" "),e("i",{staticClass:"icon el-icon-s-operation"})])}],m={name:"mycard",computed:Object(o["a"])({},Object(r["b"])(["avatar"]))},h=m,d=(e("8f20"),e("2877")),v=Object(d["a"])(h,l,u,!1,null,"0b635a7e",null),_=v.exports,p={timeout:6e4,timer:null,serverTimer:null,reset:function(){this.timer&&clearTimeout(this.timer),this.serverTimer&&clearTimeout(this.serverTimer)},start:function(t){var s=this;this.reset(),this.timer=setTimeout((function(){console.log("发送心跳,后端收到后，返回一个心跳消息"),t.send(JSON.stringify({heart:1})),s.serverTimer=setTimeout((function(){t.close()}),s.timeout)}),this.timeout)}},f={name:"chatroom",components:{mycard:_},data:function(){return{group_list:[],message_list:[],selectId:"",selectName:"",empty_warn:!1,listQuery:{search:"",join_user:"",group:void 0},temp:{create_user:"",group:"",message:""},room_name:"",ws_uri:"/ws/chat/",lockReconnect:!1,maxReconnect:5,socket:null}},computed:Object(o["a"])({},Object(r["b"])(["user_id"])),created:function(){this.getGroupList()},mounted:function(){},destroyed:function(){this.socket.close()},methods:{getGroupList:function(){var t=this;this.listQuery.join_user=this.user_id,n["d"].requestGet(this.listQuery).then((function(s){t.group_list=s.results;var e,i=Object(c["a"])(t.group_list);try{for(i.s();!(e=i.n()).done;){var a=e.value;t.initWebSocket(a.code)}}catch(o){i.e(o)}finally{i.f()}}))},getMessageList:function(t){var s=this,e={group:t};n["e"].requestGet(e).then((function(t){s.message_list=t.results}))},scrollToBottom:function(){var t=this;this.$nextTick((function(){setTimeout((function(){t.$refs.list_message.scrollTop=t.$refs.list_message.scrollHeight}),0)}))},selectGroup:function(t){this.message_list=[],this.room_name=t.code,this.selectId=t.id,this.selectName=t.name,this.message_list=t.messages,this.scrollToBottom(),this.temp={user_id:this.user_id,group_id:t.id,message:""}},onKeyup:function(t){13===t.keyCode&&this.sendMessage()},sendMessage:function(){var t=this;""===this.temp.message.replace(/[\r\n]/g,"")?(this.empty_warn=!0,setTimeout((function(){t.empty_warn=!1}),1e3)):this.websocketsend(),this.temp.message=""},reconnect:function(){var t=this;console.log("尝试重连"),this.lockReconnect||this.maxReconnect<=0||setTimeout((function(){t.initWebSocket()}),6e4)},initWebSocket:function(t){try{if("WebSocket"in window){var s="https:"==window.location.protocol?"wss://":"ws://",e=window.location.host,i=s+e+this.ws_uri+t;console.log(i),this.socket=new WebSocket(i)}else console.log("您的浏览器不支持websocket");this.socket.onopen=this.websocketonopen,this.socket.onerror=this.websocketonerror,this.socket.onmessage=this.websocketonmessage,this.socket.onclose=this.websocketclose}catch(a){console.log(123),this.reconnect()}},websocketonopen:function(){console.log("WebSocket连接成功",this.socket.readyState),p.start(this.socket)},websocketonerror:function(t){console.log("WebSocket连接发生错误",t),this.reconnect()},websocketonmessage:function(t){var s=JSON.parse(t.data);this.message_list.push(s),this.scrollToBottom(),p.start(this.socket)},websocketclose:function(t){console.log("ws连接已断开 ("+t.code+")"),this.reconnect()},websocketsend:function(){this.socket.send(JSON.stringify(this.temp))}}},g=f,C=(e("fd7c"),Object(d["a"])(g,i,a,!1,null,"8203ba24",null));s["default"]=C.exports},"8f20":function(t,s,e){"use strict";var i=e("d8dc"),a=e.n(i);a.a},d8dc:function(t,s,e){},fd7c:function(t,s,e){"use strict";var i=e("2a87"),a=e.n(i);a.a}}]);